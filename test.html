<!DOCTYPE html>
<script src='https://d3js.org/d3.v5.min.js'></script>

<style> 
circle {stroke: black;} 

#MainChart{
    position: absolute;
    top: 0px;
    left: 0px;
    width: 100%;
}

#Menu{
    position: relative;
}


#Slides{
    opacity: 0;
    position: absolute;
    text-align: center;
    width: 200px; height: 200px;
    background: none;
    border:black;
    border-width: 15px;
}
#SlidesText{
    opacity: 0;
    position: absolute;
    text-align: center;
    width: 190px; height: 90px;
    background: none;
    border-color:black;
    border-width: 15px;
}
#ArrowBox{
    fill: lightblue;
}
#NextButton{
    opacity: 1;
    position: absolute;
    text-align: center;
    width: 50px; height: 25px;
}

#PrevButton{
    opacity: 1;
    position: absolute;
    text-align: center;
    width: 50px; height: 25px;
}

</style>

<div id=MainChart >
    <svg class='chart' viewBox='0 0 1000 700'>
        <rect id='bg'/>

        <g id='x_axis'></g>
        <g id='y_axis'></g>
        <text id='title'></text>
        <text id='x_axis_label'></text>
        <text id='y_axis_label'></text>

        <g id='points'></g>

        <rect y=1 width=999 height=80 style='fill:none; stroke:black'/>
        <rect y=80 width=999 height=620 style='fill:none; stroke:black'/>

        <foreignObject id=FoMenu x="5" y="1" width="990" height="100" opacity=1>
            <div id='Menu'>
                <p>
                    TODO: ADD MORE HERE
                </p>
                <button id=RestartNarrative onclick="RestartNarrative()" disabled>RestartNarrative</button>    Plot X Axis: <select id="x_drop" disabled></select> Plot Y Axis: <select id="y_drop" disabled></select>
            </div>
        </foreignObject>

        <g>
        <foreignObject id=FoSlides x="0" y="0" width="200" height="350" opacity=1>
            <div id='Slides' opacity=0 >
                <svg id='SlidesSVG'>
                    <g transform="translate(0 25)">
                        <path id="ArrowBox" d="M 0 0 Z" />
                    </g>
                </svg>
                <div id='SlidesText' opacity=1 ></div>
                <button id=NextButton onclick="NextSlideClick()">Next</button>
                <button id=PrevButton onclick="PrevSlideClick()">Prev</button>
            </div>
        </foreignObject>
        </g>



        
    </svg>

</div>


<div>
    Here is a <strong>paragraph</strong> that requires <em>word
    wrap</em> and has much more text to wrap and sence
    to wrappin well
    <button id=PrevButton2 onclick="PrevSlideClick()">Prev</button>
    <button id=NextButton2 onclick="NextSlideClick()">Next</button>
  </div>


<body onload='init()' style="background-color:lightblue;">
<script>

//<path id=FocusBlock d="M0,0 L1000,0 L1000,700 L0,700 Z M50,100 L50,500 L500,500 L500,50 Z" fill-rule="evenodd" style='fill:white; opacity:0'/>

var data;

// init function for the page.  load data and setup initial config
async function init() {

// load data file
data = await d3.csv("https://hgp33.github.io/covid_exit_strategy_data/total_set_2020-07-12_min.csv");

// setup svg space
margin = 75;
right_padding = 150;
chart_offset = 100;
width = 1000;
//height = 700 - chart_offset;
height = 600;

svg = d3.select('svg').attr('viewBox', '0 0 ' + width + ' ' + height)

// establish x and y params
x_name = 'TOTAL COVID+'
y_name = 'TOTAL DEATHS'
x_label = ''
y_label = ''

x_values = data.map(function(d){return +d[x_name];})
y_values = data.map(function(d){return +d[y_name];})

x_min = d3.min(x_values)
x_max = d3.max(x_values)

y_min = d3.min(y_values)
y_max = d3.max(y_values)

xdomain = [x_min, x_max];
xrange = [0,width-2*margin-right_padding];
ydomain = [y_min, y_max]
yrange = [height-2*margin, margin];

d3.select('.chart').select('#bg').attr('x', 0).attr('y', 0).attr('height', height).attr('width', width).style('fill','white')

if( x_min == 0){
    xs = d3.scaleLinear().domain(xdomain).range(xrange);
    console.log('x was 0')
    console.log(x_min)
    console.log(x_max)
    console.log(x_values)
    x_label = x_name
}
else{
    xs = d3.scaleLog().base(10).domain(xdomain).range(xrange);
    x_label = 'log(' + x_name + ')'
}

if( y_min == 0 ){
    ys = d3.scaleLinear().domain(ydomain).range(yrange);
    console.log('y was 0')
    console.log(y_min)
    console.log(y_max)
    console.log(y_values)
    y_label = y_name
}
else{
    ys = d3.scaleLog().base(10).domain(ydomain).range(yrange);
    y_label = 'log(' + y_name + ')'
}

mySlide = d3.select('#SlidesText')

d3.select('#points')
    .attr('transform','translate('+margin+','+margin+')')
    .selectAll('circle')
    .data(data)
    .enter()
    .append('circle')
    .attr('cx', function(d,i){return xs(d[x_name]);})
    .attr('cy', function(d,i){return ys(d[y_name]);})
    .attr('r', 3)
    .attr('fill',function(d){return d['GATING SCORE COLOR']});
    //.attr('r', function(d,i){return (2 + Number(d.EngineCylinders));});

svg.select('#y_axis_label')
    .attr("transform", "rotate(-90)")
    .attr("x", -((height/2)+ (margin/2)))
    .attr("y", margin/3)
    .style("text-anchor", "middle")
    .text(y_label);

svg.select('#x_axis_label')
    .attr("x", (width - margin - right_padding)/2 + margin)
    .attr("y", height - (margin/3))
    .style("text-anchor", "middle")
    .text(x_label);  

svg.select('#title')
    .attr("x", (width - margin - right_padding)/2 + margin)
    .attr("y", chart_offset)
    .style("text-anchor", "middle")
    .text("Covid Overview");  



d3.select('#y_axis')
    .attr('transform','translate('+margin+','+margin+')')
    //.call(d3.axisLeft(ys).tickValues(d3.range(1, 6000000 + 6000000/10, 6000000/10)).tickFormat(d3.format("~s")));
    .call(d3.axisLeft(ys).tickFormat(d3.format("~s")));

d3.select('#x_axis')
    .attr('transform','translate('+ margin +','+ (height-margin) + ')')
    //.call(d3.axisBottom(xs).tickValues(d3.range(1, 6000000 + 6000000/10, 6000000/10)).tickFormat(d3.format("~s")));
    .call(d3.axisBottom(xs).tickFormat(d3.format("~s")));

// start with slide 1
SlideOne();

// List of groups (here I have one group per column)
var xGroup = ["valueX", "valueB", "valueC"];
var yGroup = ["valueY", "valueB", "valueC"];

// add the options to the button
d3.select("#x_drop")
    .selectAll('myOptions')
    .data(xGroup)
    .enter()
    .append('option')
    .text(function (d) { return d; }) // text showed in the menu
    .attr("value", function (d) { return d; }); // corresponding value returned by the button


// When the button is changed, run the updateChart function
d3.select("#x_drop").on("change", function(d) {
    // recover the option that has been chosen
    var selectedOption = d3.select(this).property("value");
    // run the updateChart function with this selected option
    update(selectedOption);
});


// add the options to the button
d3.select("#y_drop")
    .selectAll('myOptions')
    .data(yGroup)
    .enter()
    .append('option')
    .text(function (d) { return d; }) // text showed in the menu
    .attr("value", function (d) { return d; }); // corresponding value returned by the button


// When the button is changed, run the updateChart function
d3.select("#y_drop").on("change", function(d) {
    // recover the option that has been chosen
    var selectedOption = d3.select(this).property("value");
    // run the updateChart function with this selected option
    update(selectedOption);
});


// A function that update the chart
function update(selectedGroup) {
    console.log(selectedGroup);
}

};


// Slide Box
var arrow_h  = 25;
var button_w = 50;
var t_margin = 5;

function SlideConfig(x, y, h, w, text){
    
    // duration time of transitions in and out
    dur = 500;

    x = x-w/2;
    text = '<p>' + slideNum + ' of 5'+ '</p>' + text

    d3.select('#Slides')
            .transition().duration(dur).style('opacity', 0)
            .transition().style('width', w + 'px').style('height', h + arrow_h + 'px')
            .transition().duration(dur).style('opacity', 1);

    d3.select('#SlidesSVG').transition().duration(dur).on('end', function(){
        d3.select(this).attr('width', w).attr('height', h + arrow_h);
    })

    d3.select('#NextButton').transition().duration(dur).on('end', function(){
        d3.select(this).style('top', h-2*t_margin + 'px').style('left', w*0.5+10 + 'px')
    });

    d3.select('#PrevButton').transition().duration(dur).on('end', function(){
        d3.select(this).style('top', h-2*t_margin + 'px').style('left', w*0.5-button_w-10 + 'px')
    });

    d3.select('#ArrowBox').transition().duration(dur).on('end', function(){
        d3.select(this).attr('d', 'M0 0 L0 ' +h+' L'+w+' ' +h+' L'+w+' 0 L'+(w*0.5+15)+' 0 L'+(w*0.5)+' -'+arrow_h+' L'+(w*0.5-15)+' 0 Z')
    });

    d3.select('#SlidesText').transition().duration(dur).on('end', function(){
        d3.select(this).html(text)
        .style('top', arrow_h + t_margin + 'px').style('left', t_margin + 'px')
        .style('width', w-2*t_margin + 'px').style('height', h-2*t_margin + 'px')
        .transition()
        .style('opacity',1)
    });

    d3.select('#FoSlides').transition().duration(dur).on('end', function(){
        d3.select(this)
        .attr('y', y + 'px').attr('x', x + 'px')
        .attr('width', w + 2*t_margin + 'px').attr('height', h + 2*t_margin + arrow_h + 'px')
        .transition()
        .style('opacity',1)
    });
};


function SlideOne(){
    text = 'Covid-19 has changed the world and the United states in 2020.  The spread of this virus has not been uniform across the United States.  Let’s explore the various state’s data as of July XX, 2020.'
    SlideConfig(475, 110, 200, 300, text);
};
function SlideTwo(){
    text = 'Notice that the current Gating score of most states is now Red.  This represents an overall negative situation in the United States as states are more in a shutdown status.  But some states have been hit harder than other states so far.';
    d3.select('#RestartNarrative').attr('disabled', null)
    SlideConfig(475, 350, 200, 300, text);
};
function SlideThree(){
    d3.select('#RestartNarrative').attr('disabled', '')
    text = 'As we can see the highest confirmed cases and total deaths from Covid-19 are in New York.  This observation aligns with the high population and that New York was one of the earlier states with Covid-19 earlier. ';
    SlideConfig(775, 165, 200, 300, text);
};
function SlideFour(){
    text = 'At the opposite end, we can see Alaska and Hawaii are near the other extreme.  Which again aligns with lower populations and they are also more isolated states.';
    SlideConfig(100, 400, 200, 300, text);
};
function SlideFive(){
    text = 'Other metrics also help us understand the influence of Covid-19 on the United States.  Further perspectives can be viewed in this data by changing the x and y axis in the scatter plot.';
    SlideConfig(200, 90, 200, 300, text);
};

var slideNum = 1;

function NextSlideClick(){
    console.log('here is the click');
    console.log("Next clicked " + slideNum);
    if (slideNum == 1){
        slideNum = 2;
        SlideTwo();
    }
    else if (slideNum == 2){
        slideNum = 3;
        SlideThree();
    }
    else if (slideNum == 3){
        slideNum = 4;
        SlideFour();
    }
    else if (slideNum == 4){
        slideNum = 5;
        SlideFive();
    }
    else{
        slideNum = 6;
        SlideFinal();
    }
};

function PrevSlideClick(){
    if (slideNum == 2){
        slideNum = 1;
        SlideOne();
    }
    else if (slideNum == 3){
        slideNum = 2;
        SlideTwo();
    }
    else if (slideNum == 4){
        slideNum = 3;
        SlideThree();
    }
    else if (slideNum == 5){
        slideNum = 4;
        SlideFour();
    }
    else{
        slideNum = 5;
        SlideFive();
    }
};

</script>
</body>
</html>