<!DOCTYPE html>
<script src='https://d3js.org/d3.v5.min.js'></script>

<style> 
circle {stroke: black;} 

#MainChart{
    position: absolute;
    top: 0px;
    left: 0px;
    width: 100%;
    min-width: 100px;
    max-width: 1200px;
}
#Menu{
    position: relative;
}
#Slides{
    opacity: 1;
    position: absolute;
    text-align: center;
    background: none;
    border:black;
    border-width: 15px;
}
#SlidesText{
    opacity: 1;
    position: absolute;
    text-align: center;
    background: none;
    border-color:black;
    border-width: 15px;
}
#SlideBox{
    fill: lightblue;
}
#NextButton{
    opacity: 1;
    position: absolute;
    text-align: center;
    height: 25px;
}
#PrevButton{
    opacity: 1;
    position: absolute;
    text-align: center;
    height: 25px;
}
#Details{
    position: absolute;
}
#DetailsText{
    background: white;
    border-color: black;
    border-style: solid;
    border-width: 1px;
    font-size: x-small;
}
</style>

<div id=MainChart >
    <svg class='chart' viewBox='0 0 1000 700'>
        <rect id='bg'/>

        <g id='x_axis'></g>
        <g id='y_axis'></g>
        <text id='title'></text>
        <text id='x_axis_label'></text>
        <text id='y_axis_label'></text>

        <g id='points'></g>

        <rect y=1 width=999 height=80 style='fill:none; stroke:black'/>
        <rect y=80 width=999 height=620 style='fill:none; stroke:black'/>

        <foreignObject id=FoMenu x="5" y="1" width="990" height="100" opacity=1>
            <div id='Menu'>
                <p>
                    TODO: ADD MORE HERE
                </p>
                <button id=RestartNarrative onclick="RestartNarrative()">RestartNarrative</button>    Plot X Axis: <select id="x_drop" ></select> Plot Y Axis: <select id="y_drop" ></select>
            </div>
        </foreignObject>

        <path id=FocusBlock d="M0,0 Z" fill-rule="evenodd" style='fill:white; opacity:0'/>

        <g>
        <foreignObject id=FoSlides x="0" y="0" width="0" height="0" opacity=1>
            <div id='Slides' opacity=0 >
                <svg id='SlidesSVG'>
                    <g>
                        <path id="SlideBox" d="M 0 0 Z" />
                    </g>
                </svg>
                <div id='SlidesText' opacity=1 ></div>
                <button id=NextButton onclick="NextSlideClick()">Next</button>
                <button id=PrevButton onclick="PrevSlideClick()">Prev</button>
            </div>
        </foreignObject>
        </g>

        <foreignObject id='Details' x="0" y="0" width="0" height="0" opacity=0>
            <div id='DetailsText' opacity=0></div>
        </foreignObject>

    </svg>

</div>


<body onload='init()' style="background-color:lightblue;">
<script>

// init function for the page.  load data and setup initial config
///////////////////////////////////////////////////////////////////////
var data;

// setup svg space
margin = 75;
right_padding = 150;
chart_offset = 100;
width = 1000;
//height = 700 - chart_offset;
height = 600;

// duration time of transitions in and out
dur = 500;

async function init() {

    // load data file
    data = await d3.csv("https://hgp33.github.io/covid_exit_strategy_data/total_set_2020-07-12_min.csv");

    svg = d3.select('svg').attr('viewBox', '0 0 ' + width + ' ' + height)
    
    d3.select('.chart').select('#bg').attr('x', 0).attr('y', 0).attr('height', height).attr('width', width).style('fill','white')

    data_names = ['TOTAL TESTS', 'TOTAL COVID+', 'TOTAL DEATHS', 'TEST CAPACITY (7-DAY AVG)', '% POSITIVE (7-DAY AVG)'];

    xGroup = data_names;
    yGroup = data_names;

    x_name = 'TOTAL COVID+';
    y_name = 'TOTAL DEATHS';

    d3.select("#x_drop")
        .selectAll('myOptions')
        .data(xGroup)
        .enter()
        .append('option')
        .text(function (d) { return d; })
        .attr("value", function (d) { return d; })
        .attr('selected', function (d) { if(d == x_name) { return x_name;} else { return null;} })
        
    d3.select("#x_drop")
        .on("change", function(d) { chart(d3.select('#x_drop').property('value'), d3.select('#y_drop').property('value')); });

    d3.select("#y_drop")
        .selectAll('myOptions')
        .data(yGroup)
        .enter()
        .append('option')
        .text(function (d) { return d; })
        .attr("value", function (d) { return d; })
        .attr('selected', function (d) { if(d == y_name) { return y_name;} else { return null;} })
    
    d3.select("#y_drop")
        .on("change", function(d) { chart(d3.select('#x_drop').property('value'), d3.select('#y_drop').property('value')); });

    chart(x_name, y_name)
    // start with slide 1
    RestartNarrative();
    //SlideExplore();

};
///////////////////////////////////////////////////////////////////////

// Chart graphics
///////////////////////////////////////////////////////////////////////
function chart(x_name, y_name){

    x_label = ''
    y_label = ''

    x_values = data.map(function(d){return +d[x_name];})
    y_values = data.map(function(d){return +d[y_name];})

    x_min = d3.min(x_values)
    x_max = d3.max(x_values)

    y_min = d3.min(y_values)
    y_max = d3.max(y_values)

    xdomain = [x_min, x_max];
    xrange = [0,width-2*margin-right_padding];
    ydomain = [y_min, y_max]
    yrange = [height-2*margin, margin];

    if( x_min == 0){
        xs = d3.scaleLinear().domain(xdomain).range(xrange);
        x_label = x_name
    }
    else{
        xs = d3.scaleLog().base(10).domain(xdomain).range(xrange);
        x_label = 'log(' + x_name + ')'
    }

    if( y_min == 0 ){
        ys = d3.scaleLinear().domain(ydomain).range(yrange);
        y_label = y_name
    }
    else{
        ys = d3.scaleLog().base(10).domain(ydomain).range(yrange);
        y_label = 'log(' + y_name + ')'
    }

    // create points if initial load
    d3.select('#points')
        .attr('transform','translate('+margin+','+margin+')')
        .selectAll('circle')
        .data(data)
        .enter()
        .append('circle')

    // update points from user
    d3.select('#points')
        .attr('transform','translate('+margin+','+margin+')')
        .selectAll('circle')
        .data(data)
        .on('mouseover', function(d){
            w = 210;
            h = 65;
            circle_object = d3.select(this);
            dx = +circle_object.attr("cx") + margin;
            dy = +circle_object.attr("cy") + margin;

            function row(name){
                return '<tr><td>' + name + ':</td><td>'+ d[name] + '</td></tr>';
            };

            text =  '<table style="width:100%">'
            text = text + row('STATE') 
                        + row(x_name) 
                        + row(y_name)
                        + row('GATING SCORE COLOR')
                        + '</table>';

            d3.select('#DetailsText').style('width', w + 'px').style('height', h + 'px').html(text);

            d3.select('#Details')
                .attr('opacity', 1)
                .attr('x', dx)
                .attr('y', dy)
                .attr('width', 215)
                .attr('height', 70);
            })
            .on('mouseout', function(d){
                d3.select('#DetailsText').style('width', '0px').style('height', '0px').html('');

                d3.select('#Details')
                    .attr('opacity', 0)
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', 0)
                    .attr('height', 0);
            })
        .transition().duration(dur)
        .attr('cx', function(d,i){return xs(d[x_name]);})
        .attr('cy', function(d,i){return ys(d[y_name]);})
        .attr('r', 4)
        .attr('fill',function(d){return d['GATING SCORE COLOR']})

    svg.select('#y_axis_label')
        .attr("transform", "rotate(-90)")
        .attr("x", -((height/2)+ (margin/2)))
        .attr("y", margin/3)
        .style("text-anchor", "middle")
        .transition().duration(dur)
        .text(y_label);

    svg.select('#x_axis_label')
        .attr("x", (width - margin - right_padding)/2 + margin)
        .attr("y", height - (margin/3))
        .style("text-anchor", "middle")
        .transition().duration(dur)
        .text(x_label);

    svg.select('#title')
        .attr("x", (width - margin - right_padding)/2 + margin)
        .attr("y", chart_offset)
        .style("text-anchor", "middle")
        .text("Covid Overview");  

    d3.select('#y_axis')
        .attr('transform','translate('+margin+','+margin+')')
        .transition().duration(dur)
        .call(d3.axisLeft(ys).tickFormat(d3.format("~s")));

    d3.select('#x_axis')
        .attr('transform','translate('+ margin +','+ (height-margin) + ')')
        .transition().duration(dur)
        .call(d3.axisBottom(xs).tickFormat(d3.format("~s")));
}


///////////////////////////////////////////////////////////////////////

// Slide config + transitions
///////////////////////////////////////////////////////////////////////
// slide box dim details
var button_w = 50;
var t_margin = 15;

function SlideConfig(config){

    // use center for location
    x = config.x-config.w/2;
    y = config.y;
    h = config.h;
    w = config.w;
    prev_disabled = config.prev_disabled;
    next_text = config.next_text;
    text = '<p>' + config.num + ' of 5'+ '</p>' + config.text;

    d3.select('#Slides')
            .transition().duration(dur).style('opacity', 0)
            .transition().style('width', w + 'px').style('height', h + 'px')
            .transition().duration(dur).style('opacity', 1);

    d3.select('#SlidesSVG').transition().duration(dur).on('end', function(){
        d3.select(this).attr('width', w).attr('height', h );
    })

    d3.select('#NextButton').transition().duration(dur).on('end', function(){
        if (next_text == 'Next'){
            d3.select(this).style('top', h-2.5*t_margin + 'px')
                       .style('left', w*0.5+10 + 'px')
                       .style('width', button_w + 'px')
                       .text(next_text);
        }
        else{
            d3.select(this).style('top', h-2.5*t_margin + 'px')
                       .style('left', w*0.5-button_w*1.5 + 'px')
                       .style('width', button_w*3 + 'px')
                       .text(next_text);
        }
        
    });

    d3.select('#PrevButton').transition().duration(dur).on('end', function(){
        if (prev_disabled == 0){
            d3.select(this).style('top', h-2.5*t_margin + 'px')
                           .style('left', w*0.5-button_w-10 + 'px')
                           .style('width', button_w + 'px')
                           .style('opacity', 1)
                           .attr('disabled', null);
        }else{
            d3.select(this).style('top', h-2.5*t_margin + 'px')
                           .style('left', w*0.5-button_w-10 + 'px')
                           .style('width', button_w + 'px')
                           .style('opacity', 0)
                           .attr('disabled', '');
        }
    });

    d3.select('#SlideBox').transition().duration(dur).on('end', function(){
        d3.select(this).attr('d', 'M0 0 L0 ' +h+' L'+w+' ' +h+' L'+ w + ' 0 Z')
    });

    d3.select('#SlidesText').transition().duration(dur).on('end', function(){
        d3.select(this).html(text)
        .style('top', 0 + 'px').style('left', t_margin + 'px')
        .style('width', w-2*t_margin + 'px').style('height', h-2*t_margin + 'px')
        .transition()
        .style('opacity',1)
    });

    d3.select('#FoSlides').transition().duration(dur).on('end', function(){
        d3.select(this)
        .attr('y', y + 'px').attr('x', x + 'px')
        .attr('width', w + 2*t_margin + 'px').attr('height', h + 2*t_margin + 'px')
        .transition()
        .style('opacity',1)
    });

    d3.select('#RestartNarrative').attr('disabled', config.data_button_enable);
    d3.select('#x_drop').attr('disabled', config.data_button_enable);
    d3.select('#y_drop').attr('disabled', config.data_button_enable);

    d3.select('#FocusBlock')
        .transition().duration(dur*2)
        .style('opacity', 0.6)
        .attr('d', 'M0,0 L1000,0 L1000,700 L0,700 Z')
        .transition().duration(dur*2)
        .attr('d', config.focus_block)
        .style('opacity', 0.6)
        .style('fill', 'black')
};
///////////////////////////////////////////////////////////////////////

// Slide Config
///////////////////////////////////////////////////////////////////////
function SlideOne(){
    config = {
        'x': 475, 'y': 110, 'h': 200, 'w': 300,
        'num': slideNum,
        'data_button_enable': '',
        'prev_disabled': 1,
        'next_text': 'Next',
        'focus_block': 'M0,0 L1000,0 L1000,700 L0,700 Z',
        'text': 'Covid-19 has changed the world and the United states in 2020.  The spread of this virus has not been uniform across the United States.  Let\'s explore the various state\'s data as of July XX, 2020.',
    }
    SlideConfig(config);
};
function SlideTwo(){
    config = {
        'x': 700, 'y': 325, 'h': 200, 'w': 350,
        'num': slideNum,
        'data_button_enable': '',
        'prev_disabled': 0,
        'next_text': 'Next',
        'focus_block': 'M0,0 L1000,0 L1000,700 L0,700 Z M65 440 L800 100 L800 250 L65 590 Z',
        'text': 'Notice that the current Gating score of most states is now Red.  This represents an overall negative situation in the United States as states are more in a shutdown status.  But some states have been hit harder than other states so far.',
    }
    SlideConfig(config);
};
function SlideThree(){
    config = {
        'x': 775, 'y': 165, 'h': 200, 'w': 325,
        'num': slideNum,
        'data_button_enable': '',
        'prev_disabled': 0,
        'next_text': 'Next',
        'focus_block': 'M0,0 L1000,0 L1000,700 L0,700 Z M750,140 L750,160 L800,160 L800 140 Z',
        'text': 'As we can see the highest confirmed cases and total deaths from Covid-19 are in New York.  This observation aligns with the high population and that New York was one of the earlier states with Covid-19 earlier.',
    }
    SlideConfig(config);
};
function SlideFour(){
    config = {
        'x': 200, 'y': 300, 'h': 200, 'w': 300,
        'num': slideNum,
        'data_button_enable': '',
        'prev_disabled': 0,
        'next_text': 'Next',
        'focus_block': 'M0,0 L1000,0 L1000,700 L0,700 Z M70,510 L70,530 L105,530 L105 510 Z',
        'text': 'At the opposite end, we can see Alaska and Hawaii are near the other extreme.  Which again aligns with lower populations and they are also more isolated states.',
    }
    SlideConfig(config);
};
function SlideFive(){
    config = {
        'x': 225, 'y': 60, 'h': 200, 'w': 300,
        'num': slideNum,
        'data_button_enable': '',
        'prev_disabled': 1,
        'next_text': 'Ready to Explore',
        'focus_block': 'M0,0 L1000,0 L1000,700 L0,700 Z M0,0 L1000,0 L1000,80 L0,80 Z',
        'text': 'Other metrics also help us understand the influence of Covid-19 on the United States.  Further perspectives can be viewed in this data by changing the x and y axis in the scatter plot.',
    }
    SlideConfig(config);
};

function SlideExplore(){
    config = {
        'x': 0, 'y': 0, 'h': 0, 'w': 0,
        'num': slideNum,
        'data_button_enable': null,
        'prev_disabled': 1,
        'next_text': 'Ready to Explore',
        'focus_block': 'M0,0 Z',
        'text': 'Other metrics also help us understand the influence of Covid-19 on the United States.  Further perspectives can be viewed in this data by changing the x and y axis in the scatter plot.',
    }

    SlideConfig(config);
}
///////////////////////////////////////////////////////////////////////

// Navigation
///////////////////////////////////////////////////////////////////////
var slideNum = 1;

function RestartNarrative() { slideNum = 1; SlideOne();    }

function NextSlideClick(){
    if (slideNum == 1)     { slideNum = 2; SlideTwo();    }
    else if (slideNum == 2){ slideNum = 3; SlideThree();  }
    else if (slideNum == 3){ slideNum = 4; SlideFour();   }
    else if (slideNum == 4){ slideNum = 5; SlideFive();   }
    else                   { slideNum = 6; SlideExplore();}
};

function PrevSlideClick(){
    if (slideNum == 2)     { slideNum = 1; SlideOne();   }
    else if (slideNum == 3){ slideNum = 2; SlideTwo();   }
    else if (slideNum == 4){ slideNum = 3; SlideThree(); }
    else if (slideNum == 5){ slideNum = 4; SlideFour();  }
};
///////////////////////////////////////////////////////////////////////
</script>
</body>
</html>